# Next.js ロギング設計ガイド（BFF用途・AWS運用）

## 概要
Next.js（BFF）プロジェクトにおけるロギング設計・運用ルールを、パフォーマンス・構造化・運用性の観点から整理します。

---

## 設計の基本方針
- **パフォーマンス重視**：ロギングによるオーバーヘッドを最小限に抑える
- **構造化ログ**：JSON形式で出力し、CloudWatchやDatadog等での検索・集計・可視化を容易にする
- **必要十分な機能性**：レベル制御・出力先制御・スタックトレース等、運用に必要な機能を備える

---

## ロギング設計・運用のポイント

### ロギングの役割と設計観点
- ログは「システムの状態・異常・操作履歴」を記録し、運用・監視・障害対応・分析の基盤とする
- 「検索・集計・可視化・アラート」など運用面での活用を前提に設計する
- 出力の粒度・タイミング・内容は、システムの責務や運用要件に応じて明確に定義する

### middlewareでのロギング
- Next.jsのmiddleware（Edge Runtime）ではNode.jsロギングライブラリ（pino等）は利用不可
- そのため、middleware内ではconsole.logしか使えないが、パフォーマンスや機能面で制約が大きいため、**middlewareでのロギングは極力避ける**

---

## ログ出力の実装方針

**明示的にログ関数（logger.infoなど）を呼び出し、出力の粒度やタイミングを各関数・各ページで明確に記述する運用を推奨します。**

この方針とする理由：
- 高階関数（ラップ関数）による自動ロギングは、ガイドライン標準とするには難易度が高いため
- 特にServer Components（例: page.tsx）はReactの仕組み上、関数ラップや副作用の注入ができず、高階関数による自動ロギングは実装できない（useEffect等も利用不可）
- router.tsやServerActions等で高階関数による自動ロギングを部分的に導入することも可能だが、page.tsxではログ関数呼び出しが必須となり、運用が二重管理となるため、**全体で汎用性の高い「ログ関数呼び出し」方式に統一する**ことが妥当と判断した

---

## まとめ
- ロギング設計は「パフォーマンス・構造化・運用性」を重視する
- 本番は構造化ロガー（pino等）を必須とし、console.logは開発用に限定
- middlewareやServer Componentsでは制約があるため、設計時に十分考慮する
