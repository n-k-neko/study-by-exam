# Next.jsのロギング戦略とライブラリ選定（BFF用途・AWS運用）

## 目的
AWS上でNext.jsを**BFF（Backend for Frontend）**として使用する場合において、適切なロギング戦略とライブラリ選定を行う。

---

## ロギング設計
### 主要なロギングライブラリ
- `console`
  - Node.js標準のロギング機能
  - 開発環境でのデバッグには適している
  - 本番環境では機能が限定的
  - パフォーマンスへの影響が大きい
- `pino`
  - 高速なJSONロガー
  - 構造化ログに特化
  - アクティブなメンテナンス
- `winston`
  - 多機能なロギングライブラリ
  - 柔軟な設定が可能
  - 広く使用されている

### 選択基準
1. パフォーマンス
   - BFFは高負荷が予想される
   - ロギングによるオーバーヘッドを最小限に
2. 構造化ログ
   - ログ分析の容易さ
   - 検索・集計の効率化
3. メンテナンス性
   - アクティブな開発
   - コミュニティの規模
4. 機能性
   - 必要な機能の充足
   - 拡張性

---
### `console.log` が本番で不適な理由

| 問題点 | 説明 |
|--------|------|
| ログレベル管理不可 | `info`, `warn`, `error` の制御ができず、環境ごとの出し分けが困難。 |
| 構造化されていない | ログがプレーンテキストなので、CloudWatchやDatadogでの検索・可視化に不向き。 |
| 出力先の制御不可 | ファイル保存、リモート転送などができず、標準出力一択。 |
| パフォーマンスへの影響 | 非効率なログ出力で、大量出力時にパフォーマンス低下のリスク。 |
| スタックトレースの制御が難しい | 手動で出力する必要があり、フォーマットも統一できない。 |
| アラート/監視連携が困難 | CloudWatch Logs Insightsでの絞り込みがしづらい。 |

---

### ロギングライブラリの利点

| 機能 | 説明 |
|------|------|
| ログレベル制御 | `info`, `debug`, `warn`, `error` などで出し分け可能。 |
| 構造化ログ | JSON形式でログ出力 → 検索・集計・アラート設定が容易。 |
| 出力先設定 | コンソール、ファイル、外部サービス（CloudWatch等）に柔軟に出力。 |
| スタックトレース自動記録 | `Error` オブジェクトを渡すだけで、スタック情報を含めたログを出力。 |
| サードパーティ連携 | Datadog, Loki, FireLens などと容易に統合可能。 |

---

### `pino` vs `winston` 比較

| 項目 | pino | winston |
|------|------|---------|
| 設計思想 | 高速・構造化ログ特化 | 多機能・整形自由 |
| 出力形式 | JSON | テキスト／JSON 両対応 |
| スタックトレース出力 | `logger.error(err)` でOK | `format.errors({ stack: true })` が必要 |
| パフォーマンス | 非常に高速（10倍以上） | やや重め |
| 出力先制御 | 柔軟（destination API） | 柔軟（transports） |
| BFF用途との相性 | ◎ | ○（複雑な要件がある場合のみ） |

#### npm ダウンロード数（2025年5月時点）

| ライブラリ | 週あたりDL数 | 傾向 |
|------------|---------------|------|
| pino       | 約11,000,000回 | 📈 急成長中 |
| winston    | 約13,500,000回 | 📉 横ばい／緩やかに下降傾向 |

※ 出典: [https://npmtrends.com/pino-vs-winston](https://npmtrends.com/pino-vs-winston)

---

## 推奨方針（Next.js BFF + AWS環境）

| 要件 | 推奨ライブラリ |
|------|----------------|
| 軽量・高速 | ✅ `pino` |
| CloudWatchなどとの連携前提 | ✅ `pino` |
| ログを構造化し検索・可視化したい | ✅ `pino` |
| ログ整形（開発用に見やすく） | ✅ `pino-pretty`（dev環境専用） |
| ログをファイルや複数出力先に保存したい | ✅ `pino`（設定はやや低レベル） / `winston`（より柔軟で直感的） |
| スタックトレースも含めたい | ✅ `pino`, `winston` どちらも対応（設定要） |
| BFFとしての責務に集中したい | ✅ `pino` 一択 |

---
### 補足：BFFとしての責務に集中したい場合、なぜ `pino` が適しているのか

BFF（Backend for Frontend）は、主にバックエンドWeb APIから取得したデータを加工・統合し、クライアントに最適な形で返す役割に集中すべきです。

そのため、BFFには以下のような特性が求められます：

- **高レスポンス性能（低レイテンシ）**
- **軽量な実行環境（LambdaやEdgeでも動作可能）**
- **構造化されたログ出力（監視・分析が前提）**
- **実装と運用の簡素化**

`pino` はこれらの要件を自然に満たすロギングライブラリです。特に：

- 最小限の依存で導入可能
- 高速なログ出力
- JSON構造ログがCloudWatchやDatadogと親和性が高い
- スタックトレースも標準的に扱える

よって、**BFFに余計な設定・重量を持ち込まず、責務に集中したい場合は `pino` 一択**といえます。

---
## 補足
### CloudWatchとJSONログの相性

| 比較項目 | テキストログ | JSONログ |
|----------|--------------|-----------|
| 検索性 | 低い（正規表現が必要） | 高い（フィールドベースで検索可能） |
| クエリ記述 | 難しい | SQLライクで簡単（Logs Insights） |
| アラート設定 | 難しい | フィールドベースで簡単に設定可能 |
| 可視化 | 限定的 | 高度なダッシュボード化が可能 |

---

### スタックトレースのログ出力例（pino）

```ts
try {
  throw new Error("Something went wrong");
} catch (err) {
  logger.error(err); // 自動で msg, type, stack を含む
}
```

```json
{
  "level": 50,
  "time": 1717250000000,
  "msg": "Something went wrong",
  "type": "Error",
  "stack": "Error: Something went wrong\n    at /app/page.ts:12:15..."
}
```
---